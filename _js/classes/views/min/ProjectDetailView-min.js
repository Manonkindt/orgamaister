var template=require("../../../_hbs/project_detail.hbs"),Project=require("../models/Project.js"),TagCollection=require("../collections/TagCollection.js"),ProjectCollection=require("../collections/ProjectCollection.js"),TagItemView=require("../views/TagItemView.js"),ProjectDetailView=Backbone.View.extend({template:template,tagName:"section",className:"dozen",events:{"click .delete":"clickDelete","click .gone":"removeFromTagsList","click .remove":"clickRemove","click .add":"clickAdd","keydown .text":"addTags","click .home":"goHome","click .gotomybox":"gotomybox"},array:[],booleancheck:!1,goHome:function(e){Window.Application.navigate("intro",{trigger:!0}),location.reload()},gotomybox:function(e){e.preventDefault(),Window.Application.navigate("boxes/"+this.model.get("box_id"),{trigger:!0})},addTags:function(e){var t=$(e.currentTarget).val().toLowerCase();if(13==e.keyCode&&""!==this.$el.find(".text").val()){(" "!==t||""!==t||void 0!==t)&&this.array.push(t),console.log("array "+this.array);var i=t.split(" ");i=i.filter(Boolean);for(var n=0;n<i.length;n++)if(" "!==i[n]){var a=document.createElement("li");a.className="item inputwrapper hidden",a.setAttribute("id",n);var l=$(".addtags ul.inputwrap .taglist"),o=document.createElement("span"),r=document.createTextNode(i[n]);o.appendChild(r);var s=document.createElement("span");s.className="remove",a.appendChild(o),a.appendChild(s),l.append(a),this.$el.find(".text").val("")}}},clickRemove:function(e){var t=$(e.currentTarget.parentNode).attr("id"),i=this.array.join(),n=i.split(" ");allIds=document.getElementsByClassName("item inputwrapper");var a=[];n.splice(t,1),$(e.currentTarget.parentNode).remove();for(var l=0;l<allIds.length;l++)allIds[l].setAttribute("id",l),a.push(allIds[l].getElementsByTagName("span")[0].innerHTML);this.array=a},clickAdd:function(e){if(e.preventDefault(),!(""===this.$el.find(".text").val()&&0===document.getElementsByClassName("item inputwrapper").length||" "===this.$el.find(".text").val()&&0===document.getElementsByClassName("item inputwrapper").length)){var t=this.array,i=this.tag,n=this.model;if(!(""===this.$el.find(".text").val()&&0===document.getElementsByClassName("item inputwrapper").length||" "===this.$el.find(".text").val()&&0===document.getElementsByClassName("item inputwrapper").length)){" "===this.$el.find(".text").val()||""!==this.$el.find(".text").val()&&t.push($(".addtags .text").val());var a=t.join(" ");console.log(a),i.create({box_name:n.get("box_name"),tag:a,project_name:n.get("name"),project_id:n.get("id"),box_id:n.get("box_id")},{success:function(e){$(".item.inputwrapper").remove(),location.reload()}}),n.set("tags_list",n.get("tags_list")+", "+a)&&(n.save(),location.reload())}}},changeScore:function(e){e.preventDefault(),this.model.set("name",this.$el.find(".name").val()),this.model.save()},removeFromTagsList:function(e){e.preventDefault();var t=e.currentTarget.parentNode.getElementsByTagName("p")[0].innerHTML,i=this.model.get("tags_list").replace(", "+t,"");this.model.set("tags_list",i),this.model.save()},clickDelete:function(e){e.preventDefault(),document.getElementById("popup").className="";var t=document.getElementById("popup"),i=this.model;t.getElementsByClassName("go")[0].addEventListener("click",function(e){e.preventDefault(),i.destroy(),$.ajax({type:"DELETE",url:window.settings.httpRoot+"api/tags/project/"+i.get("id"),success:function(e){}}),document.getElementById("popup").className="hidden"}),t.getElementsByClassName("no")[0].addEventListener("click",function(e){e.preventDefault(),document.getElementById("popup").className="hidden"})},initialize:function(e){e&&e.id&&(this.model=new Project,this.model.on("destroy",function(){Window.Application.navigate("overview",{trigger:!0})}),this.model.set("id",e.id),this.model.fetch({success:function(e,t){0===t.length&&Window.Application.navigate("overview",{trigger:!0})}}),this.listenTo(this.model,"sync",this.render),this.tag=new TagCollection({project_id:e.id}),this.tag.on("sync",this.renderAllTags,this))},renderAllTags:function(){this.$tag.empty(),this.tag.forEach(this.renderTag,this)},renderTag:function(e){this.$tag.append(new TagItemView({model:e}).render().el)},render:function(){return this.$el.html(this.template(this.model.attributes)),this.$tag=this.$el.find(".tagresults"),this.tag.fetch(),this}},{levenshtein_distance_a:function(e,t){if(0==e.length)return t.length;if(0==t.length)return e.length;var i=[],n;for(n=0;n<=t.length;n++)i[n]=[n];var a;for(a=0;a<=e.length;a++)i[0][a]=a;for(n=1;n<=t.length;n++)for(a=1;a<=e.length;a++)t.charAt(n-1)==e.charAt(a-1)?i[n][a]=i[n-1][a-1]:i[n][a]=Math.min(i[n-1][a-1]+1,Math.min(i[n][a-1]+1,i[n-1][a]+1));return i[t.length][e.length]}});module.exports=ProjectDetailView;