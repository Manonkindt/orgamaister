var template=require("../../../_hbs/project_detail.hbs"),Project=require("../models/Project.js"),TagCollection=require("../collections/TagCollection.js"),ProjectCollection=require("../collections/ProjectCollection.js"),TagItemView=require("../views/TagItemView.js"),ProjectDetailView=Backbone.View.extend({template:template,tagName:"section",className:"dozen",events:{"click .delete":"clickDelete","click .gone":"removeFromTagsList","click .remove":"clickRemove","click .add":"clickAdd","keydown .text":"addTags","click .home":"goHome","click .gotomybox":"gotomybox"},array:[],booleancheck:!1,goHome:function(e){Window.Application.navigate("intro",{trigger:!0}),location.reload()},gotomybox:function(e){e.preventDefault(),Window.Application.navigate("boxes/"+this.model.get("box_id"),{trigger:!0})},addTags:function(e){var t=$(e.currentTarget).val().toLowerCase();if(32==e.keyCode&&""!==this.$el.find(".text").val()){(" "!==t||""!==t||void 0!==t)&&this.array.push(t);var i=t.split(" ");i=i.filter(Boolean);for(var a=0;a<i.length;a++)if(" "!==i[a]){var n=document.createElement("li");n.className="item inputwrapper",n.setAttribute("id",a);var l=$(".addtags ul.inputwrap .taglist"),o=document.createElement("span"),s=document.createTextNode(i[a]);o.appendChild(s);var r=document.createElement("span");r.className="remove",n.appendChild(o),n.appendChild(r),l.append(n),this.$el.find(".text").val("")}}},clickRemove:function(e){var t=$(e.currentTarget.parentNode).attr("id"),i=this.array.join(),a=i.split(" ");allIds=document.getElementsByClassName("item inputwrapper");var n=[];a.splice(t,1),$(e.currentTarget.parentNode).remove();for(var l=0;l<allIds.length;l++)allIds[l].setAttribute("id",l),n.push(allIds[l].getElementsByTagName("span")[0].innerHTML);this.array=n},clickAdd:function(e){if(e.preventDefault(),!(""===this.$el.find(".text").val()&&0===document.getElementsByClassName("item inputwrapper").length||" "===this.$el.find(".text").val()&&0===document.getElementsByClassName("item inputwrapper").length)){var t=this.array,i=this.tag,a=this.model;if(!(""===this.$el.find(".text").val()&&0===document.getElementsByClassName("item inputwrapper").length||" "===this.$el.find(".text").val()&&0===document.getElementsByClassName("item inputwrapper").length)){" "===this.$el.find(".text").val()||""!==this.$el.find(".text").val()&&t.push($(".addtags .text").val());var n=t.join(" ");if(0!==document.getElementsByClassName("item inputwrapper").length)for(var l=0;l<t.length;l++)t[l]=t[l].replace(/\s+/g," "),i.create({box_name:a.get("box_name"),tag:t[l],project_name:a.get("name"),project_id:a.get("id"),box_id:a.get("box_id")},{success:function(e){$(".item.inputwrapper").remove()}}),a.set("tags_list",a.get("tags_list")+", "+t[l])&&(a.save(),location.reload());else for(var o=n.split(" "),l=0;l<o.length;l++)o[l]=o[l].replace(/\s+/g," "),i.create({box_name:a.get("box_name"),tag:o[l],project_name:a.get("name"),project_id:a.get("id"),box_id:a.get("box_id")},{success:function(e){$(".item.inputwrapper").remove(),location.reload()}}),a.set("tags_list",a.get("tags_list")+", "+o[l])&&(a.save(),location.reload())}}},changeScore:function(e){e.preventDefault(),this.model.set("name",this.$el.find(".name").val()),this.model.save()},removeFromTagsList:function(e){e.preventDefault();var t=e.currentTarget.parentNode.getElementsByTagName("p")[0].innerHTML,i=this.model.get("tags_list").replace(", "+t,"");this.model.set("tags_list",i),this.model.save()},clickDelete:function(e){e.preventDefault(),document.getElementById("popup").className="";var t=document.getElementById("popup"),i=this.model;t.getElementsByClassName("go")[0].addEventListener("click",function(e){e.preventDefault(),i.destroy(),$.ajax({type:"DELETE",url:window.settings.httpRoot+"api/tags/project/"+i.get("id"),success:function(e){}}),document.getElementById("popup").className="hidden"}),t.getElementsByClassName("no")[0].addEventListener("click",function(e){e.preventDefault(),document.getElementById("popup").className="hidden"})},initialize:function(e){e&&e.id&&(this.model=new Project,this.model.on("destroy",function(){Window.Application.navigate("overview",{trigger:!0})}),this.model.set("id",e.id),this.model.fetch({success:function(e,t){0===t.length&&Window.Application.navigate("overview",{trigger:!0})}}),this.listenTo(this.model,"sync",this.render),this.tag=new TagCollection({project_id:e.id}),this.tag.on("sync",this.renderAllTags,this))},renderAllTags:function(){this.$tag.empty(),this.tag.forEach(this.renderTag,this)},renderTag:function(e){this.$tag.append(new TagItemView({model:e}).render().el)},render:function(){return this.$el.html(this.template(this.model.attributes)),this.$tag=this.$el.find(".tagresults"),this.tag.fetch(),this}},{levenshtein_distance_a:function(e,t){if(0==e.length)return t.length;if(0==t.length)return e.length;var i=[],a;for(a=0;a<=t.length;a++)i[a]=[a];var n;for(n=0;n<=e.length;n++)i[0][n]=n;for(a=1;a<=t.length;a++)for(n=1;n<=e.length;n++)t.charAt(a-1)==e.charAt(n-1)?i[a][n]=i[a-1][n-1]:i[a][n]=Math.min(i[a-1][n-1]+1,Math.min(i[a][n-1]+1,i[a-1][n]+1));return i[t.length][e.length]}});module.exports=ProjectDetailView;